<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¹´ë©”ë¼ ë¹„ìœ¨ ë³´ì • ë° í•„í„° ì ìš©</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    color: white;
    font-family: sans-serif;
    overflow: hidden;
  }

  #camera-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    background: black;
    overflow: hidden;
    aspect-ratio: 1 / 1; /* ê¸°ë³¸ ì •ì‚¬ê°í˜• */
    transition: aspect-ratio 0.3s ease;
  }

  video, #preview {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #filter-overlay {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    pointer-events: none;
    opacity: 1;
    z-index: 1;
  }

  #preview {
    display: none;
    z-index: 2;
  }

  #filter-panel {
    position: fixed;
    bottom: 70px;
    left: 0;
    width: 100%;
    max-width: 600px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(6px);
    padding: 15px 0 20px;
    display: none;
    z-index: 10;
  }

  #slider-container {
    width: 80%;
    max-width: 400px;
    text-align: center;
    margin: 0 auto 12px;
  }

  #filter-selector {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .filter-option {
    width: 60px;
    height: 60px;
    border: 2px solid transparent;
    border-radius: 6px;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    transition: border 0.2s;
  }
  .filter-option.selected { border-color: #1e90ff; }

  #controls {
    position: fixed;
    bottom: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px 0 12px;
    background: rgba(0, 0, 0, 0.8);
    z-index: 20;
  }

  button {
    background-color: #1e90ff;
    border: none;
    color: white;
    padding: 10px 16px;
    font-size: 1em;
    border-radius: 6px;
    cursor: pointer;
  }

  #toggleFilterBtn {
    background-color: #32cd32;
  }
</style>
</head>
<body>

  <!-- ğŸ“¸ ì¹´ë©”ë¼ -->
  <div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <div id="filter-overlay"></div>
    <img id="preview" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€" />
  </div>

  <!-- ğŸ¨ í•„í„° íŒ¨ë„ -->
  <div id="filter-panel">
    <div id="slider-container">
      <label for="opacitySlider">í•„í„° íˆ¬ëª…ë„: <span id="opacityValue">100%</span></label>
      <input type="range" id="opacitySlider" min="0" max="100" value="100" />
    </div>

    <div id="filter-selector">
      <div class="filter-option selected" style="background-image:url('filter1.png')" data-src="filter1.png"></div>
      <div class="filter-option" style="background-image:url('filter2.png')" data-src="filter2.png"></div>
      <div class="filter-option" style="background-image:url('filter3.png')" data-src="filter3.png"></div>
    </div>
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <!-- ì¡°ì‘ ë²„íŠ¼ -->
  <div id="controls">
    <button id="switchBtn">ğŸ”„ ì „/í›„ë©´ ì „í™˜</button>
    <button id="captureBtn">ğŸ“¸ ì´¬ì˜</button>
    <button id="retryBtn" style="display:none;">â†© ë‹¤ì‹œ</button>
    <button id="toggleFilterBtn">ğŸ¨ í•„í„° ì„¤ì • ì—´ê¸°</button>
    <button id="saveBtn" disabled>ğŸ’¾ ì €ì¥</button>
    <button id="shareBtn" disabled>ğŸ“¤ ê³µìœ </button>
  </div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('snapshot');
    const preview = document.getElementById('preview');
    const filterOverlay = document.getElementById('filter-overlay');
    const cameraContainer = document.getElementById('camera-container');
    const toggleFilterBtn = document.getElementById('toggleFilterBtn');
    const filterPanel = document.getElementById('filter-panel');
    const filterSelector = document.getElementById('filter-selector');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValue = document.getElementById('opacityValue');
    const captureBtn = document.getElementById('captureBtn');
    const retryBtn = document.getElementById('retryBtn');
    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const switchBtn = document.getElementById('switchBtn');

    let stream;
    let currentFacingMode = 'environment';
    let currentOpacity = 1.0;
    let currentFilter = 'filter1.png';
    let filterPanelOpen = false;

    // ğŸ“¸ ì¹´ë©”ë¼ ì‹¤í–‰
    async function initCamera(facingMode = 'environment') {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ' + err.message);
      }
    }
    initCamera();

    // ğŸ¨ í•„í„° ì—´ê³  ë‹«ê¸°
    toggleFilterBtn.addEventListener('click', () => {
      filterPanelOpen = !filterPanelOpen;
      filterPanel.style.display = filterPanelOpen ? 'block' : 'none';
      toggleFilterBtn.textContent = filterPanelOpen ? 'âŒ í•„í„° ë‹«ê¸°' : 'ğŸ¨ í•„í„° ì—´ê¸°';
      toggleFilterBtn.style.backgroundColor = filterPanelOpen ? '#ff6347' : '#32cd32';
    });

    // âœ… í•„í„° ì„ íƒ ì‹œ ë¹„ìœ¨ ì¡°ì •
    function setCameraAspectByFilter(filterSrc) {
      const img = new Image();
      img.onload = () => {
        const ratio = img.width / img.height;
        cameraContainer.style.aspectRatio = `${img.width} / ${img.height}`;
        console.log(`ğŸ“ í•„í„° ì´ë¯¸ì§€ ë¹„ìœ¨: ${ratio.toFixed(3)} (${img.width}x${img.height})`);
      };
      img.src = filterSrc;
    }

    // âœ… ì´ˆê¸° í•„í„° ì ìš©
    setCameraAspectByFilter(currentFilter);
    filterOverlay.style.backgroundImage = `url('${currentFilter}')`;

    // âœ… í•„í„° ì„ íƒ
    filterSelector.addEventListener('click', e => {
      if (e.target.classList.contains('filter-option')) {
        document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
        e.target.classList.add('selected');
        currentFilter = e.target.dataset.src;
        filterOverlay.style.backgroundImage = `url('${currentFilter}')`;
        setCameraAspectByFilter(currentFilter);
      }
    });

    // âœ… íˆ¬ëª…ë„ ì¡°ì ˆ
    opacitySlider.addEventListener('input', e => {
      const v = e.target.value;
      currentOpacity = v / 100;
      opacityValue.textContent = `${v}%`;
      filterOverlay.style.opacity = currentOpacity;
    });

    // âœ… ë¹„ìœ¨ ë³´ì • ìº¡ì²˜ (ëˆŒë¦¼ ë°©ì§€)
    captureBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      canvas.width = vw;
      canvas.height = vh;

      const videoRatio = vw / vh; // ì‹¤ì œ ì¹´ë©”ë¼ ë¹„ìœ¨
      const displayRatio = video.clientWidth / video.clientHeight; // í™”ë©´ í‘œì‹œ ë¹„ìœ¨

      let sx = 0, sy = 0, sw = vw, sh = vh;

      if (displayRatio > videoRatio) {
        // í™”ë©´ì´ ë” ë„“ìŒ â†’ ì„¸ë¡œ crop
        sh = vw / displayRatio;
        sy = (vh - sh) / 2;
      } else if (displayRatio < videoRatio) {
        // í™”ë©´ì´ ë” ë†’ìŒ â†’ ê°€ë¡œ crop
        sw = vh * displayRatio;
        sx = (vw - sw) / 2;
      }

      // cropëœ ê·¸ëŒ€ë¡œ ê·¸ë¦¼ (ë¹„ìœ¨ ìœ ì§€)
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

      const filterImg = new Image();
      filterImg.src = currentFilter;
      filterImg.onload = () => {
        // âœ… cover ë°©ì‹ìœ¼ë¡œ í•„í„° í•©ì„±
        ctx.globalAlpha = currentOpacity;
        const imgRatio = filterImg.width / filterImg.height;
        let fw, fh, fx, fy;
        if (imgRatio > videoRatio) {
          fh = canvas.height;
          fw = filterImg.width * (fh / filterImg.height);
          fx = (canvas.width - fw) / 2; fy = 0;
        } else {
          fw = canvas.width;
          fh = filterImg.height * (fw / filterImg.width);
          fx = 0; fy = (canvas.height - fh) / 2;
        }
        ctx.drawImage(filterImg, fx, fy, fw, fh);
        ctx.globalAlpha = 1.0;

        preview.src = canvas.toDataURL('image/png');
        preview.style.display = 'block';
        saveBtn.disabled = false;
        shareBtn.disabled = false;
        captureBtn.style.display = 'none';
        retryBtn.style.display = 'inline-block';
      };
    });

    // â†© ë‹¤ì‹œ
    retryBtn.addEventListener('click', () => {
      preview.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      retryBtn.style.display = 'none';
      saveBtn.disabled = true;
      shareBtn.disabled = true;
    });

    // ğŸ’¾ ì €ì¥
    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'photo.png';
      link.href = preview.src;
      link.click();
    });

    // ğŸ“¤ ê³µìœ 
    shareBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(preview.src);
        const blob = await res.blob();
        const file = new File([blob], 'photo.png', { type: 'image/png' });
        if (navigator.share) {
          await navigator.share({
            files: [file],
            title: 'ë‚´ ì‚¬ì§„',
            text: 'í•„í„° ì ìš© ì‚¬ì§„ ê³µìœ  ğŸ“¸',
          });
        } else {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        alert('ê³µìœ  ì‹¤íŒ¨: ' + err.message);
      }
    });

    // ğŸ”„ ì „/í›„ë©´ ì „í™˜
    switchBtn.addEventListener('click', () => {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      initCamera(currentFacingMode);
    });
  </script>
</body>
</html>
