<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¹´ë©”ë¼ ë¹„ìœ¨ ìë™ ë³´ì •</title>
<style>
  body {
    margin: 0;
    background: black;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    color: white;
    font-family: sans-serif;
    overflow: hidden;
  }

  #camera-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    flex-grow: 1;
    background: #000;
    overflow: hidden;
  }

  video, #filter-overlay, #preview {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #filter-overlay {
    background-size: cover;
    background-position: center;
    opacity: 1;
    pointer-events: none;
    z-index: 2;
  }

  #preview {
    display: none;
    z-index: 3;
  }

  #controls {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 10px;
  }

  button {
    background: #1e90ff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 15px;
    font-size: 1em;
  }
</style>
</head>
<body>

<div id="camera-container">
  <video id="camera" autoplay playsinline></video>
  <div id="filter-overlay"></div>
  <img id="preview" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€">
</div>

<div id="controls">
  <button id="switchBtn">ğŸ”„ ì „/í›„ë©´</button>
  <button id="captureBtn">ğŸ“¸ ì´¬ì˜</button>
  <button id="retryBtn" style="display:none;">â†© ë‹¤ì‹œ</button>
  <button id="saveBtn" disabled>ğŸ’¾ ì €ì¥</button>
</div>

<canvas id="snapshot" style="display:none;"></canvas>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const preview = document.getElementById('preview');
const filterOverlay = document.getElementById('filter-overlay');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const retryBtn = document.getElementById('retryBtn');
const saveBtn = document.getElementById('saveBtn');

let stream;
let facingMode = 'environment';
let currentFilter = 'filter1.png';
let currentOpacity = 1.0;

// âœ… ì¹´ë©”ë¼ ì‹œì‘
async function initCamera(mode='environment') {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: false });
    video.srcObject = stream;
    facingMode = mode;
  } catch(e) {
    alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + e.message);
  }
}
initCamera(facingMode);

// ğŸ”„ ì „í›„ë©´ ì „í™˜
switchBtn.addEventListener('click', ()=> {
  facingMode = (facingMode === 'user') ? 'environment' : 'user';
  initCamera(facingMode);
});

// ğŸ¨ í•„í„° ê¸°ë³¸ ì„¤ì •
filterOverlay.style.backgroundImage = `url('${currentFilter}')`;

// âœ… ë¹„ìœ¨ ë³´ì • ìº¡ì²˜ í•¨ìˆ˜ (í•µì‹¬)
function drawVideoToCanvas() {
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  const cw = vw;
  const ch = vh;
  canvas.width = cw;
  canvas.height = ch;
  const ctx = canvas.getContext('2d');

  // ì˜ìƒí™”ë©´ vs ìº”ë²„ìŠ¤ ë¹„ìœ¨ ë§ì¶°ì„œ crop ê³„ì‚°
  const videoRatio = vw / vh; // 1.78 (16:9 ì˜ˆì‹œ)
  const displayRatio = video.clientWidth / video.clientHeight; // ì˜ˆ: 0.75 (3:4)
  
  let sx = 0, sy = 0, sw = vw, sh = vh;
  
  if (displayRatio > videoRatio) {
    // í™”ë©´ì´ ë” ë„“ì„ ë•Œ â†’ ì„¸ë¡œ crop
    sh = vw / displayRatio;
    sy = (vh - sh) / 2;
  } else if (displayRatio < videoRatio) {
    // í™”ë©´ì´ ë” ë†’ì„ ë•Œ â†’ ê°€ë¡œ crop
    sw = vh * displayRatio;
    sx = (vw - sw) / 2;
  }

  // ì‹¤ì œ cropëœ ì˜ìƒ ê·¸ë¦¬ê¸°
  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);

  // í•„í„° í•©ì„±
  const filter = new Image();
  filter.src = currentFilter;
  filter.onload = () => {
    ctx.globalAlpha = currentOpacity;
    ctx.drawImage(filter, 0, 0, cw, ch);
    ctx.globalAlpha = 1.0;
    preview.src = canvas.toDataURL('image/png');
    preview.style.display = 'block';
    captureBtn.style.display = 'none';
    retryBtn.style.display = 'inline-block';
    saveBtn.disabled = false;
  };
}

// ğŸ“¸ ì´¬ì˜
captureBtn.addEventListener('click', drawVideoToCanvas);

// â†© ë‹¤ì‹œ
retryBtn.addEventListener('click', ()=>{
  preview.style.display = 'none';
  captureBtn.style.display = 'inline-block';
  retryBtn.style.display = 'none';
  saveBtn.disabled = true;
});

// ğŸ’¾ ì €ì¥
saveBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = preview.src;
  a.download = 'photo.png';
  a.click();
});
</script>
</body>
</html>
