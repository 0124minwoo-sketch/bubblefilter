<script>
  const video = document.getElementById('camera');
  const canvas = document.getElementById('snapshot');
  const preview = document.getElementById('preview');
  const filterOverlay = document.getElementById('filter-overlay');
  const cameraContainer = document.getElementById('camera-container');
  const toggleFilterBtn = document.getElementById('toggleFilterBtn');
  const filterPanel = document.getElementById('filter-panel');
  const filterSelector = document.getElementById('filter-selector');
  const opacitySlider = document.getElementById('opacitySlider');
  const opacityValue = document.getElementById('opacityValue');
  const captureBtn = document.getElementById('captureBtn');
  const retryBtn = document.getElementById('retryBtn');
  const saveBtn = document.getElementById('saveBtn');
  const shareBtn = document.getElementById('shareBtn');

  let stream;
  let currentFacingMode = 'environment';
  let currentOpacity = 1.0;
  let currentFilter = 'filter1.png';
  let filterPanelOpen = false;

  // ðŸ“· ì¹´ë©”ë¼ ì‹¤í–‰
  async function initCamera(facingMode = 'environment') {
    if (stream) stream.getTracks().forEach(t => t.stop());
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
      video.srcObject = stream;
    } catch (err) {
      alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ' + err.message);
    }
  }

  initCamera();

  // ðŸŽ¨ í•„í„° ì—´ê³  ë‹«ê¸°
  toggleFilterBtn.addEventListener('click', () => {
    filterPanelOpen = !filterPanelOpen;
    filterPanel.style.display = filterPanelOpen ? 'block' : 'none';
    toggleFilterBtn.textContent = filterPanelOpen ? 'âŒ í•„í„° ë‹«ê¸°' : 'ðŸŽ¨ í•„í„° ì—´ê¸°';
    toggleFilterBtn.style.backgroundColor = filterPanelOpen ? '#ff6347' : '#32cd32';
  });

  // âœ… í•„í„° ì„ íƒ ì‹œ ì¹´ë©”ë¼ ë¹„ìœ¨ ìžë™ ì¡°ì •
  function setCameraAspectByFilter(filterSrc) {
    const img = new Image();
    img.onload = () => {
      const ratio = img.width / img.height;
      cameraContainer.style.aspectRatio = `${img.width} / ${img.height}`;
      console.log(`ðŸ“ í•„í„° ì´ë¯¸ì§€ ë¹„ìœ¨ ì„¤ì •: ${ratio.toFixed(3)} (${img.width}x${img.height})`);
    };
    img.src = filterSrc;
  }

  // ì´ˆê¸° í•„í„° ë¹„ìœ¨ ì„¸íŒ…
  setCameraAspectByFilter(currentFilter);
  filterOverlay.style.backgroundImage = `url('${currentFilter}')`;

  // í•„í„° ì„ íƒ
  filterSelector.addEventListener('click', e => {
    if (e.target.classList.contains('filter-option')) {
      document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
      e.target.classList.add('selected');
      currentFilter = e.target.dataset.src;
      filterOverlay.style.backgroundImage = `url('${currentFilter}')`;
      setCameraAspectByFilter(currentFilter); // âœ… ë¹„ìœ¨ ì—…ë°ì´íŠ¸
    }
  });

  // íˆ¬ëª…ë„ ì¡°ì ˆ
  opacitySlider.addEventListener('input', e => {
    const v = e.target.value;
    currentOpacity = v / 100;
    opacityValue.textContent = `${v}%`;
    filterOverlay.style.opacity = currentOpacity;
  });

  // âœ… ì´¬ì˜ ê¸°ëŠ¥ â€” ì˜ìƒ ë¹„ìœ¨ê³¼ ë™ì¼í•˜ê²Œ ì €ìž¥ë˜ë„ë¡ ìˆ˜ì •
  captureBtn.addEventListener('click', () => {
    if (!video.videoWidth || !video.videoHeight) return;

    const vw = video.videoWidth;
    const vh = video.videoHeight;

    // ìº”ë²„ìŠ¤ë¥¼ ì‹¤ì œ ì˜ìƒ í•´ìƒë„ ë¹„ìœ¨ë¡œ ì„¤ì •
    canvas.width = vw;
    canvas.height = vh;

    const ctx = canvas.getContext('2d');

    // ì˜ìƒ ë¨¼ì € ê·¸ë¦¼
    ctx.drawImage(video, 0, 0, vw, vh);

    // í•„í„° ì´ë¯¸ì§€ë¥¼ ì˜ìƒ ìœ„ì— ë§ì”Œì›€
    if (currentFilter) {
      const img = new Image();
      img.src = currentFilter;
      img.onload = () => {
        ctx.globalAlpha = currentOpacity;
        ctx.drawImage(img, 0, 0, vw, vh);
        ctx.globalAlpha = 1.0;

        // ìº”ë²„ìŠ¤ ë‚´ìš©ì„ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œ
        preview.src = canvas.toDataURL('image/png');
        preview.style.display = 'block';
        video.style.display = 'none';

        captureBtn.style.display = 'none';
        retryBtn.style.display = 'inline-block';
        saveBtn.disabled = false;
        shareBtn.disabled = false;
      };
    }
  });

  // ë‹¤ì‹œ ì´¬ì˜ ë²„íŠ¼
  retryBtn.addEventListener('click', () => {
    preview.style.display = 'none';
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
    retryBtn.style.display = 'none';
    saveBtn.disabled = true;
    shareBtn.disabled = true;
  });
</script>
