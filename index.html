<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¹´ë©”ë¼ ì´¬ì˜ ë° ì €ì¥/ê³µìœ </title>
<style>
  body {
    margin: 0;
    padding: 0;
    background-color: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
    color: white;
    font-family: sans-serif;
  }

  #camera-container {
    position: relative;
    flex: 1;
    width: 100%;
    max-width: 600px;
    background: black;
    overflow: hidden;
  }

  video, #preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
  }

  #filter-overlay {
    position: absolute;
    inset: 0;
    background-image: url('filter.png');
    background-size: cover;
    background-position: center;
    opacity: 1;
    pointer-events: none;
    z-index: 1;
  }

  #slider-container {
    width: 80%;
    max-width: 400px;
    text-align: center;
    margin: 10px 0;
  }

  input[type="range"] { width: 100%; }

  #controls {
    position: fixed;
    bottom: 10px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 8px;
    z-index: 100;
    background: rgba(0,0,0,0.5);
    padding: 10px 0;
    backdrop-filter: blur(4px);
  }

  button {
    background-color: #1e90ff;
    border: none;
    color: white;
    padding: 10px 16px;
    font-size: 1em;
    border-radius: 6px;
    cursor: pointer;
  }

  #preview { display: none; z-index: 2; }

</style>
</head>
<body>

<div id="camera-container">
  <video id="camera" autoplay playsinline></video>
  <div id="filter-overlay"></div>
  <img id="preview" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€">
</div>

<div id="slider-container">
  <label for="opacitySlider">í•„í„° íˆ¬ëª…ë„: <span id="opacityValue">100%</span></label>
  <input type="range" id="opacitySlider" min="0" max="100" value="100">
</div>

<canvas id="snapshot" style="display:none;"></canvas>

<div id="controls">
  <button id="switchBtn">ğŸ”„ ì „/í›„ë©´ ì „í™˜</button>
  <button id="captureBtn">ğŸ“¸ ì´¬ì˜</button>
  <button id="retryBtn" style="display:none;">â†© ë‹¤ì‹œ</button>
  <button id="saveBtn" disabled>ğŸ’¾ ì €ì¥</button>
  <button id="shareBtn" disabled>ğŸ“¤ ê³µìœ </button>
</div>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const preview = document.getElementById('preview');
const filterOverlay = document.getElementById('filter-overlay');
const captureBtn = document.getElementById('captureBtn');
const retryBtn = document.getElementById('retryBtn');
const saveBtn = document.getElementById('saveBtn');
const shareBtn = document.getElementById('shareBtn');
const switchBtn = document.getElementById('switchBtn');
const opacitySlider = document.getElementById('opacitySlider');
const opacityValue = document.getElementById('opacityValue');

let stream;
let currentFacingMode = 'environment'; // í›„ë©´ì¹´ë©”ë¼ ê¸°ë³¸
let currentOpacity = 1.0;

// ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
async function initCamera(facingMode = 'environment') {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode }
    });
    video.srcObject = stream;
    currentFacingMode = facingMode;
  } catch (err) {
    alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ' + err.message);
  }
}
initCamera(currentFacingMode);

// ì¹´ë©”ë¼ ì „í™˜
switchBtn.addEventListener('click', ()=>{
  currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
  initCamera(currentFacingMode);
});

// íˆ¬ëª…ë„ ì¡°ì ˆ
opacitySlider.addEventListener('input', e=>{
  const value = e.target.value;
  currentOpacity = value/100;
  opacityValue.textContent = `${value}%`;
  filterOverlay.style.opacity = currentOpacity;
});

// âœ… ì´¬ì˜ ë¡œì§ ìˆ˜ì • (ë¹„ìœ¨ ìœ ì§€)
captureBtn.addEventListener('click', ()=>{
  const videoRatio = video.videoWidth / video.videoHeight;
  const displayRatio = video.clientWidth / video.clientHeight;

  let drawWidth = video.videoWidth;
  let drawHeight = video.videoHeight;

  // ìº”ë²„ìŠ¤ í¬ê¸° ê³ ì •: ì˜ìƒ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€
  canvas.width = drawWidth;
  canvas.height = drawHeight;

  const ctx = canvas.getContext('2d');

  // ì‹¤ì œ í•´ìƒë„ ê¸°ì¤€ìœ¼ë¡œ í”„ë ˆì„ ìº¡ì²˜
  ctx.drawImage(video, 0, 0, drawWidth, drawHeight);

  // í•„í„° ì˜¤ë²„ë ˆì´ (filter.pngëŠ” 2500x2500ì´ë¼ ë¹„ìœ¨ ë§ì¶°ì„œ ê·¸ë¦¬ê¸°)
  const filter = new Image();
  filter.src = 'filter.png';
  filter.onload = ()=>{
    // cover ë°©ì‹ìœ¼ë¡œ í•„í„° ì´ë¯¸ì§€ ë§ì¶”ê¸°
    const imgRatio = filter.width / filter.height;
    let fw, fh, fx, fy;
    if (imgRatio > videoRatio) {
      // í•„í„°ê°€ ë” ê°€ë¡œë¡œ ë„“ìœ¼ë©´ ë†’ì´ì— ê¸°ì¤€
      fh = drawHeight;
      fw = filter.width * (fh / filter.height);
      fx = (drawWidth - fw) / 2;
      fy = 0;
    } else {
      // í•„í„°ê°€ ì„¸ë¡œë¡œ ê¸¸ë©´ í­ì— ê¸°ì¤€
      fw = drawWidth;
      fh = filter.height * (fw / filter.width);
      fx = 0;
      fy = (drawHeight - fh) / 2;
    }

    ctx.globalAlpha = currentOpacity;
    ctx.drawImage(filter, fx, fy, fw, fh);
    ctx.globalAlpha = 1.0;

    preview.src = canvas.toDataURL('image/png');
    preview.style.display = 'block';
    captureBtn.style.display = 'none';
    retryBtn.style.display = 'inline-block';
    saveBtn.disabled = false;
    shareBtn.disabled = false;
  };
});

// ë‹¤ì‹œ ì´¬ì˜
retryBtn.addEventListener('click', ()=>{
  preview.style.display = 'none';
  captureBtn.style.display = 'inline-block';
  retryBtn.style.display = 'none';
  saveBtn.disabled = true;
  shareBtn.disabled = true;
});

// ì €ì¥
saveBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.download = 'photo.png';
  a.href = preview.src;
  a.click();
});

// ê³µìœ 
shareBtn.addEventListener('click', async ()=>{
  if (navigator.share) {
    const res = await fetch(preview.src);
    const blob = await res.blob();
    const file = new File([blob], 'photo.png',{type:'image/png'});
    await navigator.share({files:[file], title:'ë‚˜ì˜ ì‚¬ì§„'});
  } else alert('ë¸Œë¼ìš°ì €ê°€ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
});
</script>
</body>
</html>
