<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹´ë©”ë¼ ì´¬ì˜ ë° ì €ì¥/ê³µìœ </title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }

    #camera-container {
      position: relative;
      flex: 1;
      width: 100%;
      max-width: 600px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: black;
    }

    video, #preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      left: 0;
      top: 0;
    }

    #preview {
      display: none;
      z-index: 2;
    }

    #filter-overlay {
      position: absolute;
      inset: 0;
      background-image: url('filter.png'); /* í•„í„° ì´ë¯¸ì§€ */
      background-size: cover;
      background-position: center;
      opacity: 1;
      pointer-events: none;
      z-index: 1;
      transition: opacity 0.2s;
    }

    #slider-container {
      width: 80%;
      max-width: 400px;
      text-align: center;
      margin: 10px 0;
    }

    input[type="range"] {
      width: 100%;
    }

    #controls {
      position: fixed;
      bottom: 10px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      z-index: 99;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px 0;
      backdrop-filter: blur(5px);
    }

    button {
      background-color: #1e90ff;
      border: none;
      color: white;
      padding: 10px 16px;
      font-size: 1em;
      border-radius: 6px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    label {
      display: block;
      font-size: 0.9em;
      color: #ddd;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <div id="filter-overlay"></div>
    <img id="preview" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€" />
  </div>

  <div id="slider-container">
    <label for="opacitySlider">
      í•„í„° íˆ¬ëª…ë„ ì¡°ì ˆ: <span id="opacityValue">100%</span>
    </label>
    <input type="range" id="opacitySlider" min="0" max="100" value="100" />
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <div id="controls">
    <button id="switchBtn">ğŸ”„ ì¹´ë©”ë¼ ì „í™˜</button>
    <button id="captureBtn">ğŸ“¸ ì´¬ì˜</button>
    <button id="saveBtn" disabled>ğŸ’¾ ì €ì¥</button>
    <button id="shareBtn" disabled>ğŸ“¤ ê³µìœ </button>
    <button id="retryBtn" style="display:none;">â†© ë‹¤ì‹œ ì´¬ì˜</button>
  </div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('snapshot');
    const preview = document.getElementById('preview');
    const filterOverlay = document.getElementById('filter-overlay');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const retryBtn = document.getElementById('retryBtn');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValue = document.getElementById('opacityValue');

    let stream;
    let currentFacingMode = 'environment'; // âœ… ê¸°ë³¸ê°’ì„ í›„ë©´ ì¹´ë©”ë¼ë¡œ ë³€ê²½
    let currentOpacity = 1.0;

    // ì¹´ë©”ë¼ ì‹¤í–‰
    async function initCamera(facingMode = 'environment') {
      if (stream) stream.getTracks().forEach(track => track.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        video.srcObject = stream;
        currentFacingMode = facingMode;
      } catch (err) {
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + err.message);
      }
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ í›„ë©´ ì¹´ë©”ë¼ ì‹¤í–‰
    initCamera(currentFacingMode);

    // ì¹´ë©”ë¼ ì „í™˜ ê¸°ëŠ¥
    switchBtn.addEventListener('click', () => {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      initCamera(currentFacingMode);
    });

    // íˆ¬ëª…ë„ ìŠ¬ë¼ì´ë”
    opacitySlider.addEventListener('input', e => {
      const value = e.target.value;
      const opacity = value / 100;
      currentOpacity = opacity;
      filterOverlay.style.opacity = opacity;
      opacityValue.textContent = `${value}%`;
    });

    // ì´¬ì˜
    captureBtn.addEventListener('click', () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const filter = new Image();
      filter.src = 'filter.png';
      filter.onload = () => {
        context.globalAlpha = currentOpacity;
        context.drawImage(filter, 0, 0, canvas.width, canvas.height);
        context.globalAlpha = 1;

        const dataUrl = canvas.toDataURL('image/png');
        preview.src = dataUrl;
        preview.style.display = 'block';

        saveBtn.disabled = false;
        shareBtn.disabled = false;
        captureBtn.style.display = 'none';
        retryBtn.style.display = 'inline-block';
      };
    });

    // ë‹¤ì‹œ ì´¬ì˜
    retryBtn.addEventListener('click', () => {
      preview.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      retryBtn.style.display = 'none';
      saveBtn.disabled = true;
      shareBtn.disabled = true;
    });

    // ì €ì¥
    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'photo.png';
      link.href = preview.src;
      link.click();
    });

    // ê³µìœ 
    shareBtn.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          const response = await fetch(preview.src);
          const blob = await response.blob();
          const file = new File([blob], 'photo.png', { type: 'image/png' });
          await navigator.share({
            files: [file],
            title: 'ë‚˜ì˜ ì‚¬ì§„',
            text: 'ì´¬ì˜í•œ ì‚¬ì§„ì„ ê³µìœ í•©ë‹ˆë‹¤!',
          });
        } catch (err) {
          alert('ê³µìœ  ì‹¤íŒ¨: ' + err.message);
        }
      } else {
        alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ  ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    });
  </script>
</body>
</html>
